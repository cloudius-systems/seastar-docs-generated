<html lang="en" xml:lang="en">
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="Nadav Har&#8217;El - nyh@ScyllaDB.com">
  <meta name="author" content="Avi Kivity - avi@ScyllaDB.com">
  <title>Asynchronous Programming with Seastar</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {  background-color: #f8f8f8; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ef2929; } /* Alert */
    code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #c4a000; } /* Attribute */
    code span.bn { color: #0000cf; } /* BaseN */
    code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4e9a06; } /* Char */
    code span.cn { color: #000000; } /* Constant */
    code span.co { color: #8f5902; font-style: italic; } /* Comment */
    code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
    code span.dt { color: #204a87; } /* DataType */
    code span.dv { color: #0000cf; } /* DecVal */
    code span.er { color: #a40000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #0000cf; } /* Float */
    code span.fu { color: #000000; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
    code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
    code span.ot { color: #8f5902; } /* Other */
    code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
    code span.sc { color: #000000; } /* SpecialChar */
    code span.ss { color: #4e9a06; } /* SpecialString */
    code span.st { color: #4e9a06; } /* String */
    code span.va { color: #000000; } /* Variable */
    code span.vs { color: #4e9a06; } /* VerbatimString */
    code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <style type="text/css">

body {
color: #000000;
background: #FFFFFF;
font-size: 13pt;
line-height: 1.10;
font-family: arial, sans-serif; margin-left: 15pt;
margin-right: 15pt;
text-align: justify;
}

div#header, header {
border-top: 1px solid #aaa;
border-bottom: 1px solid #aaa;
background: #F0F0C0;	margin: 10pt;
margin-left: 10%;
margin-right: 10%;
}

.title {
color: #000000;
margin: 5pt;
text-align: center;
font-family: serif;
font-weight: bold;
font-size: 32pt;
}

.author, .date {
color: #000000;
margin: 0pt;
text-align: center;
font-family: serif;
font-weight: normal;
font-size: 16pt;
}

div#TOC, nav#TOC {
border-top: 1px solid #aaa;
border-bottom: 1px solid #aaa;
background: #F9F9F9;
margin: 10pt;
margin-left: 20%;
margin-right: 20%;
}
h1, h2, h3, h4, h5, h6 {
color: #EE3300;
}
a {
text-decoration: none;
}
a:link, a:visited {
color: #0000CC;	}
a:hover {
color: #CC0000;
text-decoration: underline;
}

code {
background-color: #FFFFFF;



white-space: pre-wrap; 
white-space: -moz-pre-wrap !important; 
white-space: -pre-wrap; 
white-space: -o-pre-wrap; 
word-wrap: break-word; 

}
pre {
padding: 0.5em;
border: 1px dotted #777;
margin-left: 15pt;
margin-right: 15pt;
}
pre, pre > code {
background-color: #f8f8f8;
}

@media print {
body { font-size: 11pt; }
a { color: black; background: transparent; }
pre { border: 1px solid #aaa; }
}
</style>
</head>
<body><header id="title-block-header">
<h1 class="title">Asynchronous Programming with Seastar</h1>
<p class="author">Nadav Har&#8217;El - nyh@ScyllaDB.com</p>
<p class="author">Avi Kivity - avi@ScyllaDB.com</p>
</header>
<div><a href="index.html">Back to table of contents</a>. Previous: <a href="22.html">22 Debugging a Seastar program</a>. Next: <a href="24.html">24 Memory allocation in Seastar</a>.</div><h1 data-number="23" id="promise-objects"><span class="header-section-number">23</span> Promise objects</h1>
<p>As we already defined above, An <strong>asynchronous function</strong>, also called a <strong>promise</strong>, is a function which returns a future and arranges for this future to be eventually resolved. As we already saw, an asynchronous function is usually written in terms of other asynchronous functions, for example we saw the function <code>slow()</code> which waits for the existing asynchronous function <code>sleep()</code> to complete, and then returns 3:</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true"></a>seastar::future&lt;<span class="dt">int</span>&gt; slow() {</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true"></a>    <span class="kw">using</span> <span class="kw">namespace</span> <span class="bu">std::</span>chrono_literals;</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true"></a>    <span class="cf">return</span> seastar::sleep(<span class="dv">100</span><span class="bu">ms</span>).then([] { <span class="cf">return</span> <span class="dv">3</span>; });</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true"></a>}</span></code></pre></div>
<p>The most basic building block for writing promises is the <strong>promise object</strong>, an object of type <code>promise&lt;T&gt;</code>. A <code>promise&lt;T&gt;</code> has a method <code>future&lt;T&gt; get_future()</code> to returns a future, and a method <code>set_value(T)</code>, to resolve this future. An asynchronous function can create a promise object, return its future, and the <code>set_value</code> method to be eventually called - which will finally resolve the future it returned.</p>
<p>In the following example we create a promise that manages the process of printing 10 messages, once every second. We start by creating an empty promise to work with. We then spin up a <code>seastart::thread</code> to perform the work we want. When the work, printing those messages, is completed we call <code>promise::set_value</code> to mark the completion of the task. Other than that we wait for the future which is generated by our promise, just like any other future.</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true"></a><span class="pp">#include </span><span class="im">&lt;seastar/core/future.hh&gt;</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true"></a><span class="pp">#include </span><span class="im">&lt;seastar/core/do_with.hh&gt;</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true"></a><span class="pp">#include </span><span class="im">&lt;seastar/core/sleep.hh&gt;</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true"></a><span class="pp">#include </span><span class="im">&lt;seastar/core/thread.hh&gt;</span></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true"></a></span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true"></a></span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true"></a>seastar::future&lt;&gt; f() {</span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true"></a>    <span class="cf">return</span> seastar::do_with(seastar::promise&lt;&gt;(), [](<span class="kw">auto</span>&amp; promise) {</span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true"></a>        (<span class="dt">void</span>)seastar::async([&amp;promise]() {</span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true"></a>                <span class="kw">using</span> <span class="kw">namespace</span> <span class="bu">std::</span>chrono_literals;</span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true"></a>                <span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; <span class="dv">10</span>; i++) {</span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true"></a>                    <span class="bu">std::</span>cout &lt;&lt; i &lt;&lt; <span class="st">"..."</span> &lt;&lt; <span class="bu">std::</span>flush;</span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true"></a>                    seastar::sleep(<span class="dv">1</span><span class="bu">s</span>).wait();</span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true"></a>                }</span>
<span id="cb113-16"><a href="#cb113-16" aria-hidden="true"></a>                <span class="bu">std::</span>cout &lt;&lt; <span class="bu">std::</span>endl;</span>
<span id="cb113-17"><a href="#cb113-17" aria-hidden="true"></a></span>
<span id="cb113-18"><a href="#cb113-18" aria-hidden="true"></a>                promise.set_value();</span>
<span id="cb113-19"><a href="#cb113-19" aria-hidden="true"></a>        });</span>
<span id="cb113-20"><a href="#cb113-20" aria-hidden="true"></a></span>
<span id="cb113-21"><a href="#cb113-21" aria-hidden="true"></a>        <span class="cf">return</span> promise.get_future();</span>
<span id="cb113-22"><a href="#cb113-22" aria-hidden="true"></a>    });</span>
<span id="cb113-23"><a href="#cb113-23" aria-hidden="true"></a>}</span></code></pre></div>
<div><a href="index.html">Back to table of contents</a>. Previous: <a href="22.html">22 Debugging a Seastar program</a>. Next: <a href="24.html">24 Memory allocation in Seastar</a>.</div></body></html>