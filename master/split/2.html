<html lang="en" xml:lang="en">
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="Nadav Har&#8217;El - nyh@ScyllaDB.com">
  <meta name="author" content="Avi Kivity - avi@ScyllaDB.com">
  <title>Asynchronous Programming with Seastar</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {  background-color: #f8f8f8; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ef2929; } /* Alert */
    code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #c4a000; } /* Attribute */
    code span.bn { color: #0000cf; } /* BaseN */
    code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4e9a06; } /* Char */
    code span.cn { color: #000000; } /* Constant */
    code span.co { color: #8f5902; font-style: italic; } /* Comment */
    code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
    code span.dt { color: #204a87; } /* DataType */
    code span.dv { color: #0000cf; } /* DecVal */
    code span.er { color: #a40000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #0000cf; } /* Float */
    code span.fu { color: #000000; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
    code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
    code span.ot { color: #8f5902; } /* Other */
    code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
    code span.sc { color: #000000; } /* SpecialChar */
    code span.ss { color: #4e9a06; } /* SpecialString */
    code span.st { color: #4e9a06; } /* String */
    code span.va { color: #000000; } /* Variable */
    code span.vs { color: #4e9a06; } /* VerbatimString */
    code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <style type="text/css">

body {
color: #000000;
background: #FFFFFF;
font-size: 13pt;
line-height: 1.10;
font-family: arial, sans-serif; margin-left: 15pt;
margin-right: 15pt;
text-align: justify;
}

div#header, header {
border-top: 1px solid #aaa;
border-bottom: 1px solid #aaa;
background: #F0F0C0;	margin: 10pt;
margin-left: 10%;
margin-right: 10%;
}

.title {
color: #000000;
margin: 5pt;
text-align: center;
font-family: serif;
font-weight: bold;
font-size: 32pt;
}

.author, .date {
color: #000000;
margin: 0pt;
text-align: center;
font-family: serif;
font-weight: normal;
font-size: 16pt;
}

div#TOC, nav#TOC {
border-top: 1px solid #aaa;
border-bottom: 1px solid #aaa;
background: #F9F9F9;
margin: 10pt;
margin-left: 20%;
margin-right: 20%;
}
h1, h2, h3, h4, h5, h6 {
color: #EE3300;
}
a {
text-decoration: none;
}
a:link, a:visited {
color: #0000CC;	}
a:hover {
color: #CC0000;
text-decoration: underline;
}

code {
background-color: #FFFFFF;



white-space: pre-wrap; 
white-space: -moz-pre-wrap !important; 
white-space: -pre-wrap; 
white-space: -o-pre-wrap; 
word-wrap: break-word; 

}
pre {
padding: 0.5em;
border: 1px dotted #777;
margin-left: 15pt;
margin-right: 15pt;
}
pre, pre > code {
background-color: #f8f8f8;
}

@media print {
body { font-size: 11pt; }
a { color: black; background: transparent; }
pre { border: 1px solid #aaa; }
}
</style>
</head>
<body><header id="title-block-header">
<h1 class="title">Asynchronous Programming with Seastar</h1>
<p class="author">Nadav Har&#8217;El - nyh@ScyllaDB.com</p>
<p class="author">Avi Kivity - avi@ScyllaDB.com</p>
</header>
<div><a href="index.html">Back to table of contents</a>. Previous: <a href="1.html">1 Introduction</a>. Next: <a href="3.html">3 Threads and memory</a>.</div><h1 data-number="2" id="getting-started"><span class="header-section-number">2</span> Getting started</h1>
<p>The simplest Seastar program is this:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="pp">#include </span><span class="im">&lt;seastar/core/app-template.hh&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="pp">#include </span><span class="im">&lt;seastar/core/reactor.hh&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a><span class="dt">int</span> main(<span class="dt">int</span> argc, <span class="dt">char</span>** argv) {</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a>    seastar::app_template app;</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a>    app.run(argc, argv, [] {</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a>            <span class="bu">std::</span>cout &lt;&lt; <span class="st">"Hello world</span><span class="sc">\n</span><span class="st">"</span>;</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a>            <span class="cf">return</span> seastar::make_ready_future&lt;&gt;();</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a>    });</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true"></a>}</span></code></pre></div>
<p>As we do in this example, each Seastar program must define and run, an <code>app_template</code> object. This object starts the main event loop (the Seastar <em>engine</em>) on one or more CPUs, and then runs the given function - in this case an unnamed function, a <em>lambda</em> - once.</p>
<p>The <code>return make_ready_future&lt;&gt;();</code> causes the event loop, and the whole application, to exit immediately after printing the &#8220;Hello World&#8221; message. In a more typical Seastar application, we will want event loop to remain alive and process incoming packets (for example), until explicitly exited. Such applications will return a <em>future</em> which determines when to exit the application. We will introduce futures and how to use them below. In any case, the regular C <code>exit()</code> should not be used, because it prevents Seastar or the application from cleaning up appropriately.</p>
<p>As shown in this example, all Seastar functions and types live in the &#8220;<code>seastar</code>&#8221; namespace. An user can either type this namespace prefix every time, or use shortcuts like &#8220;<code>using seastar::app_template</code>&#8221; or even &#8220;<code>using namespace seastar</code>&#8221; to avoid typing this prefix. We generally recommend to use the namespace prefixes <code>seastar</code> and <code>std</code> explicitly, and will follow this style in all the examples below.</p>
<p>To compile this program (it&#8217;s present in the <code>demos/hello-world.cc</code> file) you can just use Docker.</p>
<pre><code>$ docker build -t seastar-dev  -f ./docker/dev/Dockerfile .
$ scripts/build.sh dev
$ docker run -it --rm -v $(pwd):/seastar seastar-dev /seastar/build/dev/demos/hello-world_demo -c1</code></pre>
<p>Without the docker help, first make sure you have downloaded, built, and optionally installed Seastar, and put the above program in a source file anywhere you want, let&#8217;s call the file <code>getting-started.cc</code>.</p>
<p>Linux&#8217;s <a href="http://www.freedesktop.org/wiki/Software/pkg-config/">pkg-config</a> is one way for easily determining the compilation and linking parameters needed for using various libraries - such as Seastar. For example, if Seastar was built in the directory <code>$SEASTAR</code> but not installed, one can compile <code>getting-started.cc</code> with it using the command:</p>
<pre><code>c++ getting-started.cc `pkg-config --cflags --libs --static $SEASTAR/build/release/seastar.pc`</code></pre>
<p>The &#8220;<code>--static</code>&#8221; is needed because currently, Seastar is built as a static library, so we need to tell <code>pkg-config</code> to include its dependencies in the link command (whereas, had Seastar been a shared library, it could have pulled in its own dependencies).</p>
<p>If Seastar <em>was</em> installed, the <code>pkg-config</code> command line is even shorter:</p>
<pre><code>c++ getting-started.cc `pkg-config --cflags --libs --static seastar`</code></pre>
<p>Alternatively, one can easily build a Seastar program with CMake. Given the following <code>CMakeLists.txt</code></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cmake"><code class="sourceCode cmake"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="kw">cmake_minimum_required</span> (<span class="ot">VERSION</span> 3.5)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a><span class="kw">project</span> (SeastarExample)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a><span class="kw">find_package</span> (Seastar <span class="ot">REQUIRED</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true"></a><span class="kw">add_executable</span> (example</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true"></a>  getting-started.cc)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true"></a><span class="kw">target_link_libraries</span> (example</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true"></a>  <span class="ot">PRIVATE</span> Seastar::seastar)</span></code></pre></div>
<p>you can compile the example with the following commands:</p>
<pre class="none"><code>$ mkdir build
$ cd build
$ cmake ..
$ make</code></pre>
<p>The program now runs as expected:</p>
<pre class="none"><code>$ ./example
Hello world
$</code></pre>
<div><a href="index.html">Back to table of contents</a>. Previous: <a href="1.html">1 Introduction</a>. Next: <a href="3.html">3 Threads and memory</a>.</div></body></html>