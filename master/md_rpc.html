<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Seastar: RPC protocol</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Seastar
   </div>
   <div id="projectbrief">High performance C++ framework for concurrent servers</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">RPC protocol </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md14"></a>
Data encoding</h1>
<p>All integral data is encoded in little endian format.</p>
<h1><a class="anchor" id="autotoc_md15"></a>
Protocol negotiation</h1>
<p>The negotiation works by exchanging negotiation frame immediately after connection establishment. The negotiation frame format is: </p><pre class="fragment">uint8_t magic[8] = SSTARRPC
uint32_t len
uint8_t data[len]
</pre><p> The negotiation frame data is itself composed of multiple records, one for each feature number present. Feature numbers begin at zero and will be defined by later versions of this document.</p>
<pre class="fragment"> struct negotiation_frame_feature_record {
     uint32_t feature_number;
     uint32_t len;
     uint8_t data[len];
 }
</pre><p> A <code>negotiation_frame_feature_record</code> signals that an optional feature is present in the client, and can contain additional feature-specific data. The feature number will be omitted in a server response if an optional feature is declined by the server.</p>
<p>Actual negotiation looks like this: </p><pre class="fragment">     Client                                  Server
--------------------------------------------------------------------------------------------------
send negotiation frame
                                    recv frame
                                    check magic (disconnect if magic is not SSTARRPC)
                                    send negotiation frame back
recv frame
check magic (disconnect if magic is not SSTARRPC)
</pre> <h2><a class="anchor" id="autotoc_md16"></a>
Supported features</h2>
<h3><a class="anchor" id="autotoc_md17"></a>
Compression</h3>
<p>feature_number: 0 data : opaque data that is passed to a compressor factory provided by an application. Compressor factory is responsible for negotiation of compression algorithm.</p>
<p>If compression is negotiated request and response frames are encapsulated in a compressed frame.</p>
<h3><a class="anchor" id="autotoc_md18"></a>
Timeout propagation</h3>
<p>feature_number: 1 data : none</p>
<p>If timeout propagation is negotiated request frame has additional 8 bytes that hold timeout value for a request in milliseconds. Zero value means that timeout value was not specified. If timeout is specified and server cannot handle the request in specified time frame it my choose to not send the reply back (sending it back will not be an error either).</p>
<h3><a class="anchor" id="autotoc_md19"></a>
Connection ID</h3>
<p>feature_number: 2 uint64_t conenction_id : RPC connection ID</p>
<p>Server assigns unique connection ID for each connection and sends it to a client using this feature.</p>
<h3><a class="anchor" id="autotoc_md20"></a>
Stream parent</h3>
<p>feature_number: 3 uint64_t connection_id : RPC connection ID representing a parent of the stream</p>
<p>If this feature is present it means that the connection is not regular RPC connection but stream connection. If parent connection is closed or aborted all streams belonging to it will be closed as well.</p>
<p>Stream connection is a connection that allows bidirectional flow of bytes which may carry one or more messages in each direction. Stream connection should be explicitly closed by both client and server. Closing is done by sending special EOS frame (described below).</p>
<h3><a class="anchor" id="autotoc_md21"></a>
Isolation</h3>
<p>feature number: 4 uint32_t isolation_cookie_len uint8_t isolation_cookie[len]</p>
<p>The <code>isolation_cookie</code> field is used by the server to select a <code><a class="el" href="classseastar_1_1scheduling__group.html" title="Identifies function calls that are accounted as a group.">seastar::scheduling_group</a></code> (or equivalent in another implementation) that will run this connection. In the future it will also be used for rpc buffer isolation, to avoid rpc traffic in one isolation group from starving another.</p>
<p>The server does not directly assign meaning to values of <code>isolation_cookie</code>; instead, the interpretation is left to user code.</p>
<h4><a class="anchor" id="autotoc_md22"></a>
Compressed frame format</h4>
<p>uint32_t len uint8_t compressed_data[len]</p>
<p>after compressed_data is uncompressed it becomes regular request, response or streaming frame</p>
<h1><a class="anchor" id="autotoc_md23"></a>
Request frame format</h1>
<p>uint64_t timeout_in_ms - only present if timeout propagation is negotiated uint64_t verb_type int64_t msg_id uint32_t len uint8_t data[len]</p>
<p>msg_id has to be positive and may never be reused. data is transparent for the protocol and serialized/deserialized by a user</p>
<h1><a class="anchor" id="autotoc_md24"></a>
Response frame format</h1>
<p>int64_t msg_id uint32_t len uint8_t data[len]</p>
<p>if msg_id &lt; 0 enclosed response contains an exception that came as a response to msg id abs(msg_id) data is transparent for the protocol and serialized/deserialized by a user</p>
<h1><a class="anchor" id="autotoc_md25"></a>
Stream frame format</h1>
<p>uint32_t len uint8_t data[len]</p>
<p>len == 0xffffffff signals end of stream data is transparent for the protocol and serialized/deserialized by a user</p>
<h1><a class="anchor" id="autotoc_md26"></a>
Exception encoding</h1>
<p>uint32_t type uint32_t len uint8_t data[len]</p>
<h2><a class="anchor" id="autotoc_md27"></a>
Known exception types</h2>
<p>USER = 0 UNKNOWN_VERB = 1</p>
<h3><a class="anchor" id="autotoc_md28"></a>
USER exception encoding</h3>
<pre class="fragment">uint32_t len
char[len]
</pre><p> This exception is sent as a reply if rpc handler throws an exception. It is delivered to a caller as rpc::remote_verb_error(char[len])</p>
<h3><a class="anchor" id="autotoc_md29"></a>
UNKNOWN_VERB exception encoding</h3>
<pre class="fragment">uint64_t verb_id
</pre><p> This exception is sent as a response to a request with unknown verb_id, the verb id is passed back as part of the exception payload.</p>
<h1><a class="anchor" id="autotoc_md30"></a>
More formal protocol description</h1>
<pre class="fragment">    request_stream = negotiation_frame, { request | compressed_request }
    request = verb_type, msg_id, len, { byte }*len
    compressed_request = len, { bytes }*len
    response_stream = negotiation_frame, { response | compressed_response }
    response = reply | exception
    compressed_response = len, { byte }*len
    streaming_stream = negotiation_frame, { streaming_frame | compressed_streaming_frame }
    streaming_frame = len, { byte }*len
    compressed_streaming_frame = len, { byte }*len
    reply = msg_id, len, { byte }*len
    exception = exception_header, serialized_exception
    exception_header = -msg_id, len
    serialized_exception = (user|unknown_verb)
    user = len, {byte}*len
    unknown_verb = verb_type
    verb_type = uint64_t
    msg_id = int64_t
    len = uint32_t
    byte = uint8_t
    negotiation_frame = 'SSTARRPC' len32(negotiation_frame_data) negotiation_frame_data
    negotiation_frame_data = negotiation_frame_feature_record*
    negotiation_frame_feature_record = feature_number len {byte}*len
    feature_number = uint32_t 
</pre><p> Note that replies can come in order different from requests, and some requests may not have a reply at all. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
